<!DOCTYPE html>
<html>
<head>
    <title>Juego de Damas</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            text-align: center;
            background: #2c3e50;
            color: white;
            font-family: Arial;
        }
        canvas {
            border: 2px solid #34495e;
            background: #ecf0f1;
            margin: 20px auto;
            display: block;
        }
        .info {
            margin: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Juego de Damas</h1>
    <div class="info" id="status">Turno: Fichas Rojas</div>
    <canvas id="webglcanvas" width="500" height="500"></canvas>
    <div class="info">Haz clic en una ficha para seleccionarla, luego en un espacio vacío para mover</div>

<script id="vs" type="vertex">
        #version 300 es
        layout (location = 0) in vec2 aVertices; // (x,y)
        void main() {
            gl_Position = vec4(aVertices, 0.0, 1.0); // (x,y,z,1); coordenada normalizada
        }
</script>

<script id="fs" type="fragment">
        #version 300 es
        precision mediump float;
        uniform vec4 uColor; // r,g,b,a
        out vec4 color;
        void main() {
            color = uColor;
        }
</script>

<script>
        function main(){
            var canvas = document.getElementById("webglcanvas");
            var gl = canvas.getContext("webgl2");

            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

            // compila shader de vertice
            var shaderDeVertice = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(shaderDeVertice, 
                document.getElementById("vs").text.trim());
            gl.compileShader(shaderDeVertice); 

            // compila shader de fragmento
            var shaderDeFragmento = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(shaderDeFragmento, 
                document.getElementById("fs").text.trim());
            gl.compileShader(shaderDeFragmento); 

            // enlazar ambos
            var programaID = gl.createProgram();
            gl.attachShader(programaID, shaderDeVertice); 
            gl.attachShader(programaID, shaderDeFragmento);
            gl.linkProgram(programaID);

            gl.useProgram(programaID);

            // CONFIGURACIÓN DEL JUEGO DE DAMAS
            var tablero = [
                [0, 1, 0, 1, 0, 1, 0, 1],
                [1, 0, 1, 0, 1, 0, 1, 0],
                [0, 1, 0, 1, 0, 1, 0, 1],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0],
                [2, 0, 2, 0, 2, 0, 2, 0],
                [0, 2, 0, 2, 0, 2, 0, 2],
                [2, 0, 2, 0, 2, 0, 2, 0]
            ];
            // 0 = vacío, 1 = ficha roja, 2 = ficha azul

            var fichaSeleccionada = null;
            var turnoActual = 1; // 1 = rojas, 2 = azules
            var debeComer = false; // Indica si el jugador debe comer

            // FUNCIÓN PARA VERIFICAR MOVIMIENTOS VÁLIDOS (INCLUYendo CAPTURAS)
            function obtenerMovimientosValidos(fila, columna) {
                var movimientos = [];
                var ficha = tablero[fila][columna];
                
                // Direcciones dependiendo del color (rojas avanzan hacia abajo, azules hacia arriba)
                var direcciones = [];
                if (ficha === 1) { // Ficha roja
                    direcciones = [[1, -1], [1, 1]]; // Abajo-izquierda, Abajo-derecha
                } else if (ficha === 2) { // Ficha azul
                    direcciones = [[-1, -1], [-1, 1]]; // Arriba-izquierda, Arriba-derecha
                }

                // Verificar movimientos simples
                for (var i = 0; i < direcciones.length; i++) {
                    var nuevaFila = fila + direcciones[i][0];
                    var nuevaColumna = columna + direcciones[i][1];
                    
                    if (nuevaFila >= 0 && nuevaFila < 8 && nuevaColumna >= 0 && nuevaColumna < 8) {
                        if (tablero[nuevaFila][nuevaColumna] === 0) {
                            movimientos.push({
                                fila: nuevaFila,
                                columna: nuevaColumna,
                                tipo: 'simple',
                                captura: false
                            });
                        }
                    }
                }

                // Verificar capturas (saltos)
                for (var i = 0; i < direcciones.length; i++) {
                    var filaIntermedia = fila + direcciones[i][0];
                    var columnaIntermedia = columna + direcciones[i][1];
                    var filaDestino = fila + 2 * direcciones[i][0];
                    var columnaDestino = columna + 2 * direcciones[i][1];
                    
                    if (filaDestino >= 0 && filaDestino < 8 && columnaDestino >= 0 && columnaDestino < 8) {
                        // Verificar si hay una ficha del oponente en la posición intermedia
                        if (tablero[filaIntermedia][columnaIntermedia] !== 0 && 
                            tablero[filaIntermedia][columnaIntermedia] !== ficha &&
                            tablero[filaDestino][columnaDestino] === 0) {
                            
                            movimientos.push({
                                fila: filaDestino,
                                columna: columnaDestino,
                                tipo: 'captura',
                                fichaCapturada: {fila: filaIntermedia, columna: columnaIntermedia}
                            });
                        }
                    }
                }

                return movimientos;
            }

            // FUNCIÓN PARA VERIFICAR SI UN JUGADOR TIENE CAPTURAS OBLIGATORIAS
            function verificarCapturasObligatorias(jugador) {
                var capturasDisponibles = [];
                
                for (var fila = 0; fila < 8; fila++) {
                    for (var columna = 0; columna < 8; columna++) {
                        if (tablero[fila][columna] === jugador) {
                            var movimientos = obtenerMovimientosValidos(fila, columna);
                            for (var i = 0; i < movimientos.length; i++) {
                                if (movimientos[i].tipo === 'captura') {
                                    capturasDisponibles.push({
                                        origen: {fila: fila, columna: columna},
                                        destino: movimientos[i]
                                    });
                                }
                            }
                        }
                    }
                }
                
                return capturasDisponibles;
            }

            // GEOMETRÍA BÁSICA - CUADRADO
            var verticesCuadrado = new Float32Array([
                -0.5, -0.5,
                 0.5, -0.5,
                 0.5,  0.5,
                -0.5,  0.5
            ]);

            // GEOMETRÍA BÁSICA - CÍRCULO (36 segmentos)
            var verticesCirculo = [0, 0]; // centro
            for (var i = 0; i <= 36; i++) {
                var angle = i * 2 * Math.PI / 36;
                verticesCirculo.push(Math.cos(angle), Math.sin(angle));
            }
            verticesCirculo = new Float32Array(verticesCirculo);

            // CREAR VERTEX ARRAY PARA CUADRADO
            var cuadradoVAO = gl.createVertexArray();
            gl.bindVertexArray(cuadradoVAO);

            var bufferCuadrado = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, bufferCuadrado);
            gl.bufferData(gl.ARRAY_BUFFER, verticesCuadrado, gl.STATIC_DRAW);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            gl.bindVertexArray(null);

            // CREAR VERTEX ARRAY PARA CÍRCULO
            var circuloVAO = gl.createVertexArray();
            gl.bindVertexArray(circuloVAO);

            var bufferCirculo = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, bufferCirculo);
            gl.bufferData(gl.ARRAY_BUFFER, verticesCirculo, gl.STATIC_DRAW);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            gl.bindVertexArray(null);

            // FUNCIÓN PARA DIBUJAR CUADRADO EN POSICIÓN ESPECÍFICA
            function dibujarCuadrado(x, y, tamaño, color) {
                var vertices = new Float32Array([
                    x - tamaño, y - tamaño,
                    x + tamaño, y - tamaño,
                    x + tamaño, y + tamaño,
                    x - tamaño, y + tamaño
                ]);

                var tempBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, tempBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
                gl.enableVertexAttribArray(0);
                gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

                var uColor = gl.getUniformLocation(programaID, "uColor");
                gl.uniform4f(uColor, color[0], color[1], color[2], color[3]);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
            }

            // FUNCIÓN PARA DIBUJAR CÍRCULO EN POSICIÓN ESPECÍFICA
            function dibujarCirculo(x, y, radio, color) {
                var vertices = [x, y]; // centro
                for (var i = 0; i <= 36; i++) {
                    var angle = i * 2 * Math.PI / 36;
                    vertices.push(x + Math.cos(angle) * radio, y + Math.sin(angle) * radio);
                }

                var tempBuffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, tempBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(0);
                gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

                var uColor = gl.getUniformLocation(programaID, "uColor");
                gl.uniform4f(uColor, color[0], color[1], color[2], color[3]);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, vertices.length / 2);
            }

            // FUNCIÓN PRINCIPAL DE DIBUJO
            function dibujarEscena() {
                gl.clearColor(0.9, 0.9, 0.9, 1.0); // Fondo gris claro
                gl.clear(gl.COLOR_BUFFER_BIT);

                // DIBUJAR TABLERO
                for (var fila = 0; fila < 8; fila++) {
                    for (var columna = 0; columna < 8; columna++) {
                        var x = (columna - 3.5) * 0.2;
                        var y = (3.5 - fila) * 0.2;
                        var tamaño = 0.09;

                        // Color de la casilla
                        if ((fila + columna) % 2 === 0) {
                            dibujarCuadrado(x, y, tamaño, [0.8, 0.7, 0.6, 1.0]); // marrón claro
                        } else {
                            dibujarCuadrado(x, y, tamaño, [0.4, 0.3, 0.2, 1.0]); // marrón oscuro
                        }

                        // DIBUJAR FICHAS
                        if (tablero[fila][columna] !== 0) {
                            var colorFicha;
                            if (tablero[fila][columna] === 1) {
                                colorFicha = [1.0, 0.0, 0.0, 1.0]; // rojo
                            } else {
                                colorFicha = [0.0, 0.0, 1.0, 1.0]; // azul
                            }
                            dibujarCirculo(x, y, 0.07, colorFicha);

                            // RESALTAR FICHA SELECCIONADA
                            if (fichaSeleccionada && fichaSeleccionada.fila === fila && fichaSeleccionada.columna === columna) {
                                dibujarCirculo(x, y, 0.08, [1.0, 1.0, 0.0, 0.5]); // amarillo transparente
                            }
                        }
                    }
                }

                // MOSTRAR MOVIMIENTOS VÁLIDOS SI HAY FICHA SELECCIONADA
                if (fichaSeleccionada) {
                    var movimientos = obtenerMovimientosValidos(fichaSeleccionada.fila, fichaSeleccionada.columna);
                    
                    // Si hay capturas obligatorias, filtrar solo movimientos de captura
                    if (debeComer) {
                        movimientos = movimientos.filter(function(mov) {
                            return mov.tipo === 'captura';
                        });
                    }
                    
                    for (var i = 0; i < movimientos.length; i++) {
                        var x = (movimientos[i].columna - 3.5) * 0.2;
                        var y = (3.5 - movimientos[i].fila) * 0.2;
                        
                        if (movimientos[i].tipo === 'captura') {
                            dibujarCirculo(x, y, 0.04, [0.0, 1.0, 0.0, 0.7]); // verde para capturas
                        } else {
                            dibujarCirculo(x, y, 0.03, [0.0, 1.0, 0.0, 0.5]); // verde claro para movimientos simples
                        }
                    }
                }
            }

            // INTERACCIÓN CON EL RATÓN
            canvas.addEventListener("mousedown", function(evento) {
                var rect = canvas.getBoundingClientRect();
                var x = evento.clientX - rect.left;
                var y = evento.clientY - rect.top;

                // Convertir coordenadas de pantalla a coordenadas del tablero
                var columna = Math.floor((x / canvas.width) * 8);
                var fila = Math.floor((y / canvas.height) * 8);

                if (fila >= 0 && fila < 8 && columna >= 0 && columna < 8) {
                    if (fichaSeleccionada === null) {
                        // SELECCIONAR FICHA
                        if (tablero[fila][columna] === turnoActual) {
                            // Verificar si el jugador tiene capturas obligatorias
                            var capturas = verificarCapturasObligatorias(turnoActual);
                            if (capturas.length > 0) {
                                // Verificar si la ficha seleccionada puede capturar
                                var movimientos = obtenerMovimientosValidos(fila, columna);
                                var puedeCapturar = movimientos.some(function(mov) {
                                    return mov.tipo === 'captura';
                                });
                                
                                if (puedeCapturar) {
                                    fichaSeleccionada = {fila: fila, columna: columna};
                                    debeComer = true;
                                    document.getElementById("status").textContent = 
                                        "Debes capturar. Selecciona dónde saltar.";
                                } else {
                                    document.getElementById("status").textContent = 
                                        "Debes capturar con otra ficha.";
                                }
                            } else {
                                fichaSeleccionada = {fila: fila, columna: columna};
                                debeComer = false;
                                document.getElementById("status").textContent = 
                                    "Ficha seleccionada. Haz clic donde moverla.";
                            }
                        }
                    } else {
                        // MOVER FICHA
                        var movimientos = obtenerMovimientosValidos(fichaSeleccionada.fila, fichaSeleccionada.columna);
                        
                        // Si hay capturas obligatorias, solo permitir movimientos de captura
                        if (debeComer) {
                            movimientos = movimientos.filter(function(mov) {
                                return mov.tipo === 'captura';
                            });
                        }
                        
                        var movimientoValido = movimientos.find(function(mov) {
                            return mov.fila === fila && mov.columna === columna;
                        });

                        if (movimientoValido) {
                            // Realizar el movimiento
                            tablero[fila][columna] = tablero[fichaSeleccionada.fila][fichaSeleccionada.columna];
                            tablero[fichaSeleccionada.fila][fichaSeleccionada.columna] = 0;
                            
                            // Si fue una captura, eliminar la ficha capturada
                            if (movimientoValido.tipo === 'captura') {
                                tablero[movimientoValido.fichaCapturada.fila][movimientoValido.fichaCapturada.columna] = 0;
                                
                                // Verificar si puede seguir capturando
                                var nuevasCapturas = obtenerMovimientosValidos(fila, columna).filter(function(mov) {
                                    return mov.tipo === 'captura';
                                });
                                
                                if (nuevasCapturas.length > 0) {
                                    // Puede seguir capturando con la misma ficha
                                    fichaSeleccionada = {fila: fila, columna: columna};
                                    debeComer = true;
                                    document.getElementById("status").textContent = 
                                        "¡Captura realizada! Puedes seguir capturando.";
                                } else {
                                    // Cambiar turno
                                    turnoActual = turnoActual === 1 ? 2 : 1;
                                    fichaSeleccionada = null;
                                    debeComer = false;
                                    document.getElementById("status").textContent = 
                                        "Turno: " + (turnoActual === 1 ? "Fichas Rojas" : "Fichas Azules");
                                }
                            } else {
                                // Movimiento simple - cambiar turno
                                turnoActual = turnoActual === 1 ? 2 : 1;
                                fichaSeleccionada = null;
                                debeComer = false;
                                document.getElementById("status").textContent = 
                                    "Turno: " + (turnoActual === 1 ? "Fichas Rojas" : "Fichas Azules");
                            }
                        } else {
                            fichaSeleccionada = null;
                            debeComer = false;
                            document.getElementById("status").textContent = 
                                "Turno: " + (turnoActual === 1 ? "Fichas Rojas" : "Fichas Azules");
                        }
                    }
                    dibujarEscena();
                }
            });

            
            dibujarEscena();
        }
        window.onload = main;
</script>
</body>
</html>